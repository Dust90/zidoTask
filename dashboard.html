<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工作台 - 任务管理系统</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6/index.global.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --bg: #f8fafc;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            background: var(--bg);
            color: #1e293b;
        }
        /* 顶部导航 */
        .top-nav {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }
        /* 主内容区 */
        .dashboard {
            padding: 1.5rem;
            display: grid;
            grid-template-areas: 
                "stats stats"
                "calendar kanban"
                "tasks tasks";
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        /* 统计卡片 */
        .stats {
            grid-area: stats;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }
        /* 日历 */
        .calendar-container {
            grid-area: calendar;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 1rem;
        }
        #calendar {
            height: 400px;
        }
        /* 看板 */
        .kanban {
            grid-area: kanban;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 1rem;
        }
        .kanban-columns {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            height: 400px;
        }
        .kanban-column {
            background: #f8fafc;
            border-radius: 6px;
            padding: 1rem;
        }
        .kanban-title {
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid;
        }
        .task-card {
            background: white;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            cursor: move;
        }
        /* 任务列表 */
        .tasks {
            grid-area: tasks;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 1rem;
        }
        .task-table {
            width: 100%;
            border-collapse: collapse;
        }
        .task-table th, .task-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }
        .task-table th {
            background: #f8fafc;
            font-weight: 600;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-todo { background: #fef2f2; color: var(--danger); }
        .status-progress { background: #fff7ed; color: var(--warning); }
        .status-done { background: #f0fdf4; color: var(--success); }
        /* 新增任务按钮 */
        .add-task {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: none;
        }
        /* 响应式调整 */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-areas: 
                    "stats"
                    "calendar"
                    "kanban"
                    "tasks";
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部导航 -->
    <div class="top-nav">
        <div class="nav-title">工作台</div>
        <div class="user-menu">
            <span id="username">用户名</span>
            <img id="userAvatar" class="avatar" src="https://www.gravatar.com/avatar/default?s=200">
            <button onclick="logout()">登出</button>
        </div>
    </div>

    <!-- 主工作台 -->
    <div class="dashboard">
        <!-- 统计卡片 -->
        <div class="stats">
            <div class="stat-card">
                <h3>待办任务</h3>
                <div class="stat-value" id="todoCount">0</div>
            </div>
            <div class="stat-card">
                <h3>进行中</h3>
                <div class="stat-value" id="progressCount">0</div>
            </div>
            <div class="stat-card">
                <h3>已完成</h3>
                <div class="stat-value" id="doneCount">0</div>
            </div>
            <div class="stat-card">
                <h3>逾期任务</h3>
                <div class="stat-value" id="overdueCount">0</div>
            </div>
        </div>

        <!-- 日历 -->
        <div class="calendar-container">
            <h2>任务日历</h2>
            <div id="calendar"></div>
        </div>

        <!-- 看板 -->
        <div class="kanban">
            <h2>任务看板</h2>
            <div class="kanban-columns">
                <div class="kanban-column">
                    <div class="kanban-title" style="border-color: var(--danger);">待办</div>
                    <div id="kanban-todo" class="kanban-tasks" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                </div>
                <div class="kanban-column">
                    <div class="kanban-title" style="border-color: var(--warning);">进行中</div>
                    <div id="kanban-progress" class="kanban-tasks" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                </div>
                <div class="kanban-column">
                    <div class="kanban-title" style="border-color: var(--success);">已完成</div>
                    <div id="kanban-done" class="kanban-tasks" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                </div>
            </div>
        </div>

        <!-- 任务列表 -->
        <div class="tasks">
            <h2>最近任务</h2>
            <table class="task-table">
                <thead>
                    <tr>
                        <th>任务</th>
                        <th>截止日期</th>
                        <th>标签</th>
                        <th>状态</th>
                    </tr>
                </thead>
                <tbody id="taskTableBody">
                    <!-- 任务数据将通过JavaScript动态加载 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 新增任务按钮 -->
    <button class="add-task" onclick="showAddTaskModal()">+</button>

    <!-- 新增任务模态框 -->
    <div id="taskModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 2rem; border-radius: 8px; width: 500px; max-width: 90%;">
            <h2>新增任务</h2>
            <form id="taskForm" style="display: grid; gap: 1rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem;">任务标题</label>
                    <input type="text" id="taskTitle" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" required>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem;">描述</label>
                    <textarea id="taskDesc" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; min-height: 100px;"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem;">截止日期</label>
                        <input type="date" id="taskDueDate" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem;">优先级</label>
                        <select id="taskPriority" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="low">低</option>
                            <option value="medium" selected>中</option>
                            <option value="high">高</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem;">标签（用逗号分隔）</label>
                    <input type="text" id="taskTags" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" placeholder="设计,开发,重要">
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;">
                    <button type="button" onclick="hideAddTaskModal()" style="padding: 0.75rem 1.5rem; background: #f1f5f9; border: none; border-radius: 4px; cursor: pointer;">取消</button>
                    <button type="submit" style="padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">保存任务</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 初始化Supabase
        const supabaseUrl = 'YOUR_SUPABASE_URL';
        const supabaseKey = 'YOUR_SUPABASE_KEY';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // 当前用户和任务数据
        let currentUser = null;
        let userTasks = [];

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadUserProfile();
            await loadTasks();
            initCalendar();
            renderDashboard();
        });

        // 检查登录状态
        async function checkAuth() {
            const { data: { user }, error } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = 'login.html';
                return false;
            }
            currentUser = user;
            return true;
        }

        // 加载用户资料
        async function loadUserProfile() {
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('username, avatar_url')
                .eq('id', currentUser.id)
                .single();
            
            if (profile) {
                document.getElementById('username').textContent = profile.username || currentUser.email;
                if (profile.avatar_url) {
                    document.getElementById('userAvatar').src = profile.avatar_url;
                }
            }
        }

        // 加载任务数据
        async function loadTasks() {
            const { data: tasks, error } = await supabase
                .from('tasks')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('due_date', { ascending: true });
            
            if (tasks) {
                userTasks = tasks;
                updateStats(tasks);
            }
        }

        // 更新统计卡片
        function updateStats(tasks) {
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('todoCount').textContent = 
                tasks.filter(t => t.status === 'todo').length;
            document.getElementById('progressCount').textContent = 
                tasks.filter(t => t.status === 'progress').length;
            document.getElementById('doneCount').textContent = 
                tasks.filter(t => t.status === 'done').length;
            document.getElementById('overdueCount').textContent = 
                tasks.filter(t => t.due_date < today && t.status !== 'done').length;
        }

        // 初始化日历
        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                events: userTasks.map(task => ({
                    title: task.title,
                    start: task.due_date,
                    color: 
                        task.status === 'done' ? '#10b981' :
                        task.priority === 'high' ? '#ef4444' :
                        task.priority === 'medium' ? '#f59e0b' : '#6366f1'
                }))
            });
            calendar.render();
        }

        // 渲染看板
        function renderKanban() {
            const statusMap = {
                'todo': 'kanban-todo',
                'progress': 'kanban-progress',
                'done': 'kanban-done'
            };
            
            // 清空看板
            Object.values(statusMap).forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
            
            // 填充任务卡片
            userTasks.forEach(task => {
                const columnId = statusMap[task.status];
                if (columnId) {
                    const taskEl = document.createElement('div');
                    taskEl.className = 'task-card';
                    taskEl.draggable = true;
                    taskEl.id = task.id;
                    taskEl.ondragstart = drag;
                    taskEl.innerHTML = `
                        <div><strong>${task.title}</strong></div>
                        <div style="font-size: 0.875rem; color: #64748b; margin: 0.5rem 0;">${task.due_date}</div>
                        <div>${task.tags ? task.tags.split(',').map(tag => 
                            `<span style="display: inline-block; background: #e0e7ff; color: #4338ca; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-right: 0.25rem;">${tag.trim()}</span>`
                        ).join('') : ''}</div>
                    `;
                    document.getElementById(columnId).appendChild(taskEl);
                }
            });
        }

        // 渲染任务列表
        function renderTaskList() {
            const tableBody = document.getElementById('taskTableBody');
            tableBody.innerHTML = '';
            
            userTasks.slice(0, 5).forEach(task => {
                const row = document.createElement('tr');
                
                // 状态徽章
                let statusClass = '';
                let statusText = '';
                switch(task.status) {
                    case 'todo':
                        statusClass = 'status-todo';
                        statusText = '待办';
                        break;
                    case 'progress':
                        statusClass = 'status-progress';
                        statusText = '进行中';
                        break;
                    case 'done':
                        statusClass = 'status-done';
                        statusText = '已完成';
                        break;
                }
                
                row.innerHTML = `
                    <td>${task.title}</td>
                    <td>${task.due_date}</td>
                    <td>
                        ${task.tags ? task.tags.split(',').map(tag => 
                            `<span style="display: inline-block; background: #e0e7ff; color: #4338ca; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-right: 0.25rem;">${tag.trim()}</span>`
                        ).join('') : ''}
                    </td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                `;
                tableBody.appendChild(row);
            });
        }

        // 渲染整个工作台
        function renderDashboard() {
            updateStats(userTasks);
            initCalendar();
            renderKanban();
            renderTaskList();
        }

        // 新增任务功能
        function showAddTaskModal() {
            document.getElementById('taskModal').style.display = 'flex';
        }
        
        function hideAddTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            document.getElementById('taskForm').reset();
        }
        
        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const taskData = {
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDesc').value,
                due_date: document.getElementById('taskDueDate').value,
                priority: document.getElementById('taskPriority').value,
                tags: document.getElementById('taskTags').value,
                status: 'todo',
                user_id: currentUser.id
            };
            
            const { error } = await supabase
                .from('tasks')
                .insert(taskData);
            
            if (!error) {
                await loadTasks();
                renderDashboard();
                hideAddTaskModal();
            } else {
                alert('创建任务失败: ' + error.message);
            }
        });

        // 看板拖拽功能
        function allowDrop(ev) {
            ev.preventDefault();
        }
        
        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }
        
        async function drop(ev) {
            ev.preventDefault();
            const taskId = ev.dataTransfer.getData("text");
            const newStatus = ev.target.closest('.kanban-column').id.replace('kanban-', '');
            
            const { error } = await supabase
                .from('tasks')
                .update({ status: newStatus })
                .eq('id', taskId);
            
            if (!error) {
                await loadTasks();
                renderKanban();
            }
        }

        // 登出
        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>